<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>画像レスポンスビューア</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", Arial, sans-serif; margin: 20px; }
    h1 { margin: 0 0 12px; font-size: 1.3rem; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    input[type="text"] { flex:1 1 520px; padding:10px; border-radius:10px; border:1px solid #9993; }
    button { padding:10px 14px; border-radius:10px; border:1px solid #9993; cursor:pointer; }
    .hint { font-size:.9rem; opacity:.8; margin: 6px 0 16px; }
    .card { border:1px solid #9993; border-radius:12px; padding:12px; margin-top:12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space:pre-wrap; }
    img { margin-top:12px; max-width: min(100%, 720px); border:1px solid #9993; border-radius:8px; }
    .ok { color:#0a7f42; font-weight:600; }
    .ng { color:#b00020; font-weight:600; }
  </style>
</head>
<body>
  <h1>画像レスポンスビューア</h1>

  <div class="row">
    <input id="url" type="text" value="http://10.32.17.80:8100/cell" />
    <button id="showImgBtn">画像として表示</button>
    <button id="fetchBtn">詳細取得（fetch）</button>
  </div>
  <div class="hint">CORSが無効なAPIは「画像として表示」を使ってください。ヘッダーやステータスはCORS許可が必要です。</div>

  <div class="card">
    <div id="status">ステータス: —</div>
    <div id="headers" class="mono">ヘッダー: —</div>
    <a id="download" href="#" download style="display:none">ダウンロードリンク</a>
    <img id="image" alt="取得画像がここに表示されます" />
  </div>

  <script>
    const urlInput = document.getElementById('url');
    const showImgBtn = document.getElementById('showImgBtn');
    const fetchBtn = document.getElementById('fetchBtn');
    const statusEl = document.getElementById('status');
    const headersEl = document.getElementById('headers');
    const imgEl = document.getElementById('image');
    const dlEl = document.getElementById('download');

    // ① CORS不要：<img src> 直指定で表示
    function showAsImage() {
      const url = urlInput.value.trim();
      if (!url) return;
      headersEl.textContent = 'ヘッダー: （<img>表示では取得できません）';
      dlEl.style.display = 'inline-block';
      dlEl.href = url;
      dlEl.textContent = 'ダウンロードリンク';

      statusEl.textContent = 'ステータス: 読み込み中…';
      imgEl.onload = () => { statusEl.innerHTML = 'ステータス: <span class="ok">画像読み込み成功</span>'; };
      imgEl.onerror = () => { statusEl.innerHTML = 'ステータス: <span class="ng">画像読み込み失敗（到達性 or URL誤り）</span>'; };
      imgEl.src = url + (url.includes('?') ? '&' : '?') + '_t=' + Date.now(); // キャッシュ避け
    }

    // ② CORSが通るなら：fetchで詳細（ステータス/ヘッダー）も取得
    async function fetchDetails() {
      const url = urlInput.value.trim();
      if (!url) return;

      statusEl.textContent = 'ステータス: 読み込み中…';
      headersEl.textContent = 'ヘッダー: —';
      imgEl.src = '';
      dlEl.style.display = 'none';

      try {
        const res = await fetch(url, { method: 'GET', headers: { 'accept': '*/*' } });
        statusEl.innerHTML = `ステータス: ${res.status} ${res.statusText} ${res.ok ? '<span class="ok">(OK)</span>' : '<span class="ng">(NG)</span>'}`;

        let htxt = '';
        res.headers.forEach((v, k) => { htxt += `${k}: ${v}\n`; });
        headersEl.textContent = 'ヘッダー:\n' + (htxt || '(なし)');

        const blob = await res.blob();
        const objectURL = URL.createObjectURL(blob);
        imgEl.src = objectURL;

        // ダウンロード用
        dlEl.style.display = 'inline-block';
        dlEl.href = objectURL;
        dlEl.download = guessFilename(res.headers.get('content-disposition')) || 'download';
        dlEl.textContent = 'ダウンロードファイル';
      } catch (e) {
        statusEl.innerHTML = 'ステータス: <span class="ng">取得エラー（CORSブロックの可能性）</span>';
        headersEl.textContent = String(e);
      }
    }

    function guessFilename(cd) {
      if (!cd) return null;
      // content-disposition: attachment; filename="cell.png"
      const m = cd.match(/filename\*?=(?:UTF-8''|")?([^\";]+)/i);
      return m ? decodeURIComponent(m[1].replace(/\"/g, '')) : null;
    }

    showImgBtn.addEventListener('click', showAsImage);
    fetchBtn.addEventListener('click', fetchDetails);
  </script>
</body>
</html>
